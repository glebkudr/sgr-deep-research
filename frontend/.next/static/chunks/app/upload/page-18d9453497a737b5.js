(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[676],{4063:function(e,t,n){Promise.resolve().then(n.bind(n,3091))},3091:function(e,t,n){"use strict";n.r(t),n.d(t,{default:function(){return h}});var s=n(7437),r=n(2265),l=n(4308),a=n(9156);function i(e){let{value:t,label:n}=e,r="number"==typeof t?Math.min(100,Math.max(0,t)):null;return(0,s.jsxs)("div",{className:"progress",children:[n&&(0,s.jsx)("span",{className:"progress-label",children:n}),(0,s.jsx)("div",{className:"progress-track",children:(0,s.jsx)("div",{className:"progress-fill",style:{width:null!==r?"".concat(r,"%"):"100%"},"aria-hidden":"true"})})]})}var o=n(5101),c=n(3034),u=n(6264);let d="graphrag_recent_jobs";function h(){var e,t,n,h,m,v;let[x,j]=(0,r.useState)(""),[g,y]=(0,r.useState)([]),[N,b]=(0,r.useState)(null),[w,k]=(0,r.useState)(null),[S,I]=(0,r.useState)(!1),[T,E]=(0,r.useState)(null),[_,C]=(0,r.useState)(null),[O,R]=(0,r.useState)([]),A=g.length,z=(0,r.useRef)(null),D=(0,r.useMemo)(()=>new Set(["bsl","xml","html","htm","txt"]),[]);(0,r.useEffect)(()=>{if(z.current&&(z.current.setAttribute("webkitdirectory",""),z.current.setAttribute("directory","")),R(function(){try{let e=window.localStorage.getItem(d);return e?JSON.parse(e):[]}catch(e){return[]}}()),!w)return;let e=setInterval(async()=>{let t=await (0,u.N)({path:"/jobs/".concat(w)});t.ok&&t.data&&(b(t.data),["DONE","ERROR"].includes(t.data.status)&&(clearInterval(e),L(t.data)))},1500);return()=>clearInterval(e)},[w]);let L=(0,r.useCallback)(e=>{let t={jobId:e.job_id,collection:e.collection,status:e.status,updatedAt:new Date().toISOString()};R(e=>{let n=[t,...e.filter(e=>e.jobId!==t.jobId)].slice(0,5);return function(e){try{window.localStorage.setItem(d,JSON.stringify(e))}catch(e){}}(n),n})},[]);(0,r.useEffect)(()=>{N&&["DONE","ERROR"].includes(N.status)&&L(N)},[N,L]);let P=async()=>{if(E(null),C(null),!x.trim()){E("Укажите коллекцию.");return}if(!g.length){E("Выберите хотя бы один файл.");return}let e=new FormData;e.append("collection",x.trim()),g.forEach(t=>{let n=t.webkitRelativePath||t.name;e.append("files",t,n)}),I(!0);let t=await (0,u.N)({path:"/upload",method:"POST",body:e});if(I(!1),!t.ok||!t.data){var n;C({message:null!==(n=t.error)&&void 0!==n?n:"Не удалось создать задачу.",variant:"error"});return}b(null),k(t.data.job_id),C({message:"Задача создана, начато индексирование.",variant:"success"})},F=async e=>{let t=await (0,u.N)({path:"/jobs/".concat(e)});t.ok&&t.data&&(k(e),b(t.data),j(t.data.collection),C({message:"Загружен статус задачи.",variant:"info"}))},M=e=>{let t=(e||"").trim();if(!t){C({message:"Нет имени коллекции для просмотра в графе.",variant:"error"});return}let n="/graphview?collection=".concat(encodeURIComponent(t));window.open(n,"_blank","noopener,noreferrer")},U=(0,r.useMemo)(()=>N&&0!==A?Math.min(100,Math.round(N.stats.processed_files/A*100)):null,[N,A]);return(0,s.jsxs)("div",{className:"stack",children:[_&&(0,s.jsx)(c.F,{message:_.message,variant:_.variant,onClose:()=>C(null)}),(0,s.jsxs)("section",{className:"panel stack",children:[(0,s.jsx)("h2",{children:"Загрузка выгрузки 1С"}),(0,s.jsx)("p",{className:"text-muted",children:"Файлы будут сохранены в workspace и поставлены в очередь на обработку индексатором Neo4j/FAISS."}),(0,s.jsx)(a.I,{label:"Коллекция",value:x,onChange:e=>j(e.target.value)}),(0,s.jsxs)("label",{className:"field",children:[(0,s.jsx)("span",{className:"field-label",children:"Файлы (.bsl, .xml, .html, .txt)"}),(0,s.jsxs)("div",{className:"dropzone",children:[(0,s.jsx)("input",{ref:z,type:"file",multiple:!0,onChange:e=>{var t;E(null);let n=Array.from(null!==(t=e.target.files)&&void 0!==t?t:[]),s=n.filter(e=>{var t;let n=null!==(t=(e.webkitRelativePath||e.name).toLowerCase().split(".").pop())&&void 0!==t?t:"";return D.has(n)});s.length!==n.length&&C({message:"Некоторые файлы были отклонены: поддерживаются .bsl, .xml, .html, .txt.",variant:"error"}),y(s)},style:{display:"none"},id:"file_input",accept:".bsl,.xml,.html,.htm,.txt"}),(0,s.jsx)("p",{children:"Перетащите файлы или нажмите, чтобы выбрать."}),(0,s.jsx)(l.z,{variant:"secondary",onClick:()=>{var e;return null===(e=document.getElementById("file_input"))||void 0===e?void 0:e.click()},children:"Выбрать файлы"})]})]}),g.length>0&&(0,s.jsxs)("div",{className:"card",children:[(0,s.jsxs)("h3",{children:["Выбрано файлов: ",g.length]}),(0,s.jsx)("ul",{className:"file-list",children:g.map(e=>(0,s.jsxs)("li",{children:[(0,s.jsx)("span",{children:e.name}),(0,s.jsxs)("span",{children:[(e.size/1024).toFixed(1)," KB"]})]},e.name))})]}),T&&(0,s.jsx)("div",{className:"card status-error",children:T}),(0,s.jsx)(l.z,{onClick:P,loading:S,disabled:S,children:"Запустить индексирование"})]}),w&&(0,s.jsxs)("section",{className:"panel stack",children:[(0,s.jsxs)("header",{className:"inline",style:{justifyContent:"space-between"},children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("h2",{children:"Статус задачи"}),(0,s.jsxs)("p",{className:"text-muted",children:["Job ID: ",(0,s.jsx)("code",{children:w})]})]}),(0,s.jsx)(f,{status:null!==(e=null==N?void 0:N.status)&&void 0!==e?e:"PENDING"})]}),null!==U&&(0,s.jsx)(i,{value:U,label:"Обработка файлов"}),(0,s.jsxs)("div",{className:"card-grid",children:[(0,s.jsx)(p,{title:"Файлы",value:null!==(t=null==N?void 0:N.stats.processed_files)&&void 0!==t?t:0}),(0,s.jsx)(p,{title:"Граф: узлы",value:null!==(n=null==N?void 0:N.stats.nodes)&&void 0!==n?n:0}),(0,s.jsx)(p,{title:"Граф: связи",value:null!==(h=null==N?void 0:N.stats.edges)&&void 0!==h?h:0}),(0,s.jsx)(p,{title:"FAISS чанк",value:null!==(m=null==N?void 0:N.stats.vector_chunks)&&void 0!==m?m:0}),(0,s.jsx)(p,{title:"Длительность (сек)",value:(null!==(v=null==N?void 0:N.stats.duration_sec)&&void 0!==v?v:0).toFixed(1)})]}),(null==N?void 0:N.errors.length)?(0,s.jsxs)("div",{className:"card stack",children:[(0,s.jsx)("h3",{children:"Ошибки"}),(0,s.jsx)("ul",{className:"file-list",children:N.errors.map((e,t)=>(0,s.jsxs)("li",{children:[(0,s.jsx)("span",{children:e.message}),e.path&&(0,s.jsx)("span",{children:e.path})]},"".concat(e.message,"-").concat(t)))})]}):N&&"RUNNING"===N.status?(0,s.jsxs)("div",{className:"inline",style:{alignItems:"center"},children:[(0,s.jsx)(o.$,{}),(0,s.jsx)("span",{children:"Идет индексирование…"})]}):null]}),(0,s.jsxs)("section",{className:"panel stack",children:[(0,s.jsxs)("header",{className:"inline",style:{justifyContent:"space-between"},children:[(0,s.jsx)("h2",{children:"Недавние задачи"}),(0,s.jsx)(l.z,{variant:"secondary",onClick:()=>R([]),children:"Очистить список"})]}),0===O.length?(0,s.jsx)("p",{className:"text-muted",children:"Пока нет сохраненных задач."}):(0,s.jsx)("ul",{className:"file-list",children:O.map(e=>(0,s.jsxs)("li",{children:[(0,s.jsxs)("div",{children:[(0,s.jsx)("strong",{children:e.collection}),(0,s.jsx)("div",{className:"text-muted",children:new Date(e.updatedAt).toISOString().replace("T"," ").slice(0,19)})]}),(0,s.jsxs)("div",{className:"inline",style:{alignItems:"center",gap:"0.5rem"},children:[(0,s.jsx)(f,{status:e.status}),(0,s.jsx)(l.z,{variant:"secondary",onClick:()=>M(e.collection),children:"Открыть"}),(0,s.jsx)(l.z,{variant:"secondary",onClick:()=>F(e.jobId),children:"Статус"})]})]},e.jobId))})]})]})}function f(e){let{status:t}=e;return(0,s.jsx)("span",{className:"status-pill status-".concat(t.toLowerCase()),children:{PENDING:"Ожидает",RUNNING:"Идет",DONE:"Готово",ERROR:"Ошибка"}[t]})}function p(e){let{title:t,value:n}=e;return(0,s.jsxs)("div",{className:"card",children:[(0,s.jsx)("h4",{style:{margin:"0 0 0.25rem"},children:t}),(0,s.jsx)("strong",{style:{fontSize:"1.3rem"},children:n})]})}},4308:function(e,t,n){"use strict";n.d(t,{z:function(){return a}});var s=n(7437),r=n(6800),l=n.n(r);function a(e){let{className:t,variant:n="primary",loading:r,children:a,...i}=e;return(0,s.jsx)("button",{className:l()("btn",{"btn-primary":"primary"===n,"btn-secondary":"secondary"===n,"btn-loading":r},t),disabled:r||i.disabled,...i,children:a})}},9156:function(e,t,n){"use strict";n.d(t,{I:function(){return a}});var s=n(7437),r=n(6800),l=n.n(r);function a(e){let{label:t,error:n,className:r,...a}=e;return(0,s.jsxs)("label",{className:"field",children:[t&&(0,s.jsx)("span",{className:"field-label",children:t}),(0,s.jsx)("input",{className:l()("field-input",r,{"field-error":!!n}),...a}),n&&(0,s.jsx)("span",{className:"field-hint",children:n})]})}},5101:function(e,t,n){"use strict";n.d(t,{$:function(){return r}});var s=n(7437);function r(){return(0,s.jsx)("span",{className:"spinner","aria-hidden":"true"})}},3034:function(e,t,n){"use strict";n.d(t,{F:function(){return a}});var s=n(7437),r=n(6800),l=n.n(r);function a(e){let{message:t,variant:n="info",onClose:r}=e;return(0,s.jsxs)("div",{className:l()("toast","toast-".concat(n)),children:[(0,s.jsx)("span",{children:t}),r&&(0,s.jsx)("button",{className:"toast-close",onClick:r,"aria-label":"Close notification",children:"\xd7"})]})}},6264:function(e,t,n){"use strict";n.d(t,{N:function(){return i}});var s,r=n(357);let l=null!==(s=r.env.NEXT_PUBLIC_API_URL)&&void 0!==s?s:"http://localhost:8000",a=r.env.NEXT_PUBLIC_JWT;async function i(e){var t,n,s,r;let i;let o="".concat(l).concat(e.path),c={...null!==(n=e.headers)&&void 0!==n?n:{}};a&&(c.Authorization="Bearer ".concat(a)),e.body instanceof FormData?i=e.body:void 0!==e.body&&(c["Content-Type"]="application/json",i=JSON.stringify(e.body));let u=await fetch(o,{method:null!==(s=e.method)&&void 0!==s?s:"GET",headers:c,body:i}),d=(null===(t=u.headers.get("content-type"))||void 0===t?void 0:t.includes("application/json"))?await u.json():await u.text();return u.ok?{ok:!0,status:u.status,data:d}:{ok:!1,status:u.status,error:"string"==typeof d?d:null!==(r=null==d?void 0:d.detail)&&void 0!==r?r:"Request failed"}}},357:function(e,t,n){"use strict";var s,r;e.exports=(null==(s=n.g.process)?void 0:s.env)&&"object"==typeof(null==(r=n.g.process)?void 0:r.env)?n.g.process:n(8081)},8081:function(e){!function(){var t={229:function(e){var t,n,s,r=e.exports={};function l(){throw Error("setTimeout has not been defined")}function a(){throw Error("clearTimeout has not been defined")}function i(e){if(t===setTimeout)return setTimeout(e,0);if((t===l||!t)&&setTimeout)return t=setTimeout,setTimeout(e,0);try{return t(e,0)}catch(n){try{return t.call(null,e,0)}catch(n){return t.call(this,e,0)}}}!function(){try{t="function"==typeof setTimeout?setTimeout:l}catch(e){t=l}try{n="function"==typeof clearTimeout?clearTimeout:a}catch(e){n=a}}();var o=[],c=!1,u=-1;function d(){c&&s&&(c=!1,s.length?o=s.concat(o):u=-1,o.length&&h())}function h(){if(!c){var e=i(d);c=!0;for(var t=o.length;t;){for(s=o,o=[];++u<t;)s&&s[u].run();u=-1,t=o.length}s=null,c=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===a||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function f(e,t){this.fun=e,this.array=t}function p(){}r.nextTick=function(e){var t=Array(arguments.length-1);if(arguments.length>1)for(var n=1;n<arguments.length;n++)t[n-1]=arguments[n];o.push(new f(e,t)),1!==o.length||c||i(h)},f.prototype.run=function(){this.fun.apply(null,this.array)},r.title="browser",r.browser=!0,r.env={},r.argv=[],r.version="",r.versions={},r.on=p,r.addListener=p,r.once=p,r.off=p,r.removeListener=p,r.removeAllListeners=p,r.emit=p,r.prependListener=p,r.prependOnceListener=p,r.listeners=function(e){return[]},r.binding=function(e){throw Error("process.binding is not supported")},r.cwd=function(){return"/"},r.chdir=function(e){throw Error("process.chdir is not supported")},r.umask=function(){return 0}}},n={};function s(e){var r=n[e];if(void 0!==r)return r.exports;var l=n[e]={exports:{}},a=!0;try{t[e](l,l.exports,s),a=!1}finally{a&&delete n[e]}return l.exports}s.ab="//";var r=s(229);e.exports=r}()},6800:function(e,t){var n;/*!
	Copyright (c) 2018 Jed Watson.
	Licensed under the MIT License (MIT), see
	http://jedwatson.github.io/classnames
*/!function(){"use strict";var s={}.hasOwnProperty;function r(){for(var e="",t=0;t<arguments.length;t++){var n=arguments[t];n&&(e=l(e,function(e){if("string"==typeof e||"number"==typeof e)return e;if("object"!=typeof e)return"";if(Array.isArray(e))return r.apply(null,e);if(e.toString!==Object.prototype.toString&&!e.toString.toString().includes("[native code]"))return e.toString();var t="";for(var n in e)s.call(e,n)&&e[n]&&(t=l(t,n));return t}(n)))}return e}function l(e,t){return t?e?e+" "+t:e+t:e}e.exports?(r.default=r,e.exports=r):void 0!==(n=(function(){return r}).apply(t,[]))&&(e.exports=n)}()}},function(e){e.O(0,[971,23,744],function(){return e(e.s=4063)}),_N_E=e.O()}]);